
--#Dont Change
function getAmount(id)
    for _, x in pairs(getInventory()) do
        if x.id == id then
            return x.amount
        end
    end
    return 0
end

function send(txt)
    local var = {}
    var[0] = "OnTextOverlay"
    var[1] = txt
    sendVariant(var)
end

function join(wn, di)
    sleep(10)
    sendPacket(3, "action|join_request\nname|" .. wn .. "|" .. di .. "\ninvitedWorld|0")
end

function takeSeed()
    local seedWorld = config.Seed_Worlds[config.Current_Seed_Index]
    join(seedWorld.name, seedWorld.door_id)
    sleep(config.Delay_Warp)
    
    for _, obj in pairs(getWorldObject()) do
        if obj.id == config.Seed_ID then
            findPath(math.floor(obj.pos.x / 32), math.floor(obj.pos.y / 32))
            sleep(config.Delay_Find_Path)
            
            -- Kembali ke world farm yang sedang aktif
            local farmWorld = config.Farm_Worlds[config.Current_Farm_Index]
            join(farmWorld.name, farmWorld.door_id)
            sleep(config.Delay_Warp)
            return true
        end
    end
    return false
end

function plant()
    local farmWorld = config.Farm_Worlds[config.Current_Farm_Index]
    local hasPlanted = false
    
    for y = 1, 52 do
        for x = 0, 98 do
            if getAmount(config.Seed_ID) == 0 then
                if takeSeed() then
                    -- Setelah mengambil seed, lanjutkan penanaman
                    if not plant() then
                        return false  -- Tidak ada yang bisa ditanami
                    end
                else
                    return false  -- Gagal mengambil seed
                end
            elseif checkTile(x, y).fg == 0 and checkTile(x, y + 1).fg % 2 == 0 and checkTile(x, y + 1).fg ~= 0 then
                findPath(x, y, 200)
                sleep(config.Delay_Plant)
                sendPacketRaw(false, {
                    value = config.Seed_ID,
                    type = 3,
                    x = getLocal().pos.x,
                    y = getLocal().pos.y,
                    punchy = getLocal().pos.y / 32,
                    punchx = getLocal().pos.x / 32
                })
                sleep(config.Delay_Plant)
                hasPlanted = true
            elseif y == 1 and checkTile(x, y - 1).fg == 0 and checkTile(x, y).fg % 2 == 0 and checkTile(x, y).fg ~= 0 and getAmount(config.Seed_ID) > 0 then
                findPath(x, y - 1, 200)
                sleep(config.Delay_Plant)
                sendPacketRaw(false, {
                    value = config.Seed_ID,
                    type = 3,
                    x = getLocal().pos.x,
                    y = getLocal().pos.y,
                    punchy = getLocal().pos.y / 32,
                    punchx = getLocal().pos.x / 32
                })
                sleep(config.Delay_Plant)
                hasPlanted = true
            elseif y == 52 and checkTile(x, y).fg ~= 0 and checkTile(x, y).fg % 2 == 0 and checkTile(x, y + 1).fg == 0 and getAmount(config.Seed_ID) > 0 then
                findPath(x, y + 1, 200)
                sleep(config.Delay_Plant)
                sendPacketRaw(false, {
                    value = config.Seed_ID,
                    type = 3,
                    x = getLocal().pos.x,
                    y = getLocal().pos.y,
                    punchy = getLocal().pos.y / 32,
                    punchx = getLocal().pos.x / 32
                })
                sleep(config.Delay_Plant)
                hasPlanted = true
            end
        end
    end
    
    return hasPlanted
end

function moveToNextFarm()
    config.Current_Farm_Index = config.Current_Farm_Index + 1
    if config.Current_Farm_Index > #config.Farm_Worlds then
        config.Current_Farm_Index = 1  -- Kembali ke world pertama jika sudah sampai akhir
    end
    
    local nextWorld = config.Farm_Worlds[config.Current_Farm_Index]
    send("`9Moving to next farm: `2" .. nextWorld.name)
    join(nextWorld.name, nextWorld.door_id)
    sleep(config.Delay_Warp)
end

function Main()
    while true do
        local farmWorld = config.Farm_Worlds[config.Current_Farm_Index]
        send("`9Warping To `2" .. farmWorld.name)
        join(farmWorld.name, farmWorld.door_id)
        sleep(config.Delay_Warp)
        
        send("`9Starting To Plant A `#" .. getItemByID(config.Seed_ID).name)
        sleep(2000)
        
        -- Coba menanam di world saat ini
        local hasPlanted = plant()
        
        -- Jika tidak ada yang bisa ditanami, pindah ke world berikutnya
        if not hasPlanted then
            moveToNextFarm()
        end
        
        sleep(5000)  -- Tunggu sebentar sebelum iterasi berikutnya
    end
end

-- Menjalankan program utama
Main()
